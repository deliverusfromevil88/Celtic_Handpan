<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive 3D Handpan</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #1a2a6c, #2c3e50);
            font-family: 'Arial', sans-serif;
            color: white;
        }
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 15px;
            max-width: 300px;
            z-index: 10;
            backdrop-filter: blur(5px);
        }
        .info-panel h1 {
            margin-top: 0;
            color: #f39c12;
            font-size: 24px;
            text-align: center;
        }
        .info-panel p {
            line-height: 1.6;
            font-size: 16px;
        }
        .note-list {
            margin-top: 15px;
            padding-left: 20px;
        }
        .note-list li {
            margin-bottom: 5px;
        }
        .controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 10;
        }
        .control-btn {
            background: rgba(243, 156, 18, 0.8);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        .control-btn:hover {
            background: rgba(243, 156, 18, 1);
            transform: translateY(-3px);
        }
        .highlight {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(243, 156, 18, 0.8) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            z-index: 5;
        }
        .instructions {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 15px;
            max-width: 300px;
            z-index: 10;
            backdrop-filter: blur(5px);
        }
        .instructions h2 {
            margin-top: 0;
            color: #f39c12;
            font-size: 20px;
        }
        .instructions ul {
            padding-left: 20px;
        }
        .instructions li {
            margin-bottom: 8px;
        }
        .note-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #f39c12;
            text-shadow: 0 0 10px rgba(243, 156, 18, 0.8);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <div class="info-panel">
        <h1>Interactive 3D Handpan</h1>
        <p>This simulation features a Celtic-tuned handpan with 9 notes. Click on the notes to play them!</p>
        <div class="note-list">
            <h3>Notes:</h3>
            <ul>
                <li>0: Ding (D)</li>
                <li>1: A3</li>
                <li>2: Bb3</li>
                <li>3: C4</li>
                <li>4: D4</li>
                <li>5: E4</li>
                <li>6: F4</li>
                <li>7: G4</li>
                <li>8: A4</li>
            </ul>
        </div>
    </div>
    
    <div class="instructions">
        <h2>Instructions</h2>
        <ul>
            <li>Click on any note to play it</li>
            <li>Drag to rotate the handpan</li>
            <li>Scroll to zoom in/out</li>
            <li>Use buttons below to reset view</li>
        </ul>
    </div>
    
    <div class="controls">
        <button class="control-btn" id="resetView">Reset View</button>
        <button class="control-btn" id="topView">Top View</button>
        <button class="control-btn" id="sideView">Side View</button>
    </div>
    
    <div class="note-display" id="noteDisplay"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.32/Tone.min.js"></script>
    <script>
        // Main variables
        let scene, camera, renderer;
        let handpan, notes = [];
        let raycaster, mouse;
        let isDragging = false;
        let previousMousePosition = {x: 0, y: 0};
        let noteDisplay = document.getElementById('noteDisplay');
        
        // Note positions (relative to handpan center)
        const notePositions = [
            {x: 0, y: 0, z: 0},        // Note 0 (Ding)
            {x: 0.5, y: 0, z: 0.3},    // Note 1 (A3)
            {x: -0.5, y: 0, z: 0.3},   // Note 2 (Bb3)
            {x: 0.8, y: 0, z: 0},      // Note 3 (C4)
            {x: -0.8, y: 0, z: 0},     // Note 4 (D4)
            {x: 0.7, y: 0, z: -0.4},   // Note 5 (E4)
            {x: -0.7, y: 0, z: -0.4},  // Note 6 (F4)
            {x: 0.3, y: 0, z: -0.7},   // Note 7 (G4)
            {x: -0.3, y: 0, z: -0.7}   // Note 8 (A4)
        ];
        
        // Note frequencies (Celtic tuning)
        const noteFrequencies = [
            "D4",  // Note 0: Ding (D4)
            "A3",  // Note 1
            "Bb3", // Note 2
            "C4",  // Note 3
            "D4",  // Note 4
            "E4",  // Note 5
            "F4",  // Note 6
            "G4",  // Note 7
            "A4"   // Note 8
        ];
        
        // Initialize the scene
        function init() {
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0c0e1a);
            
            // Create camera
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.5, 3);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            // Add lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 2, 3);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            const backLight = new THREE.DirectionalLight(0xffffff, 0.4);
            backLight.position.set(-1, 1, -2);
            scene.add(backLight);
            
            // Create handpan
            createHandpan();
            
            // Set up raycasting for note interaction
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            
            // Event listeners
            window.addEventListener('resize', onWindowResize);
            document.addEventListener('mousedown', onMouseDown);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            document.addEventListener('wheel', onMouseWheel);
            document.addEventListener('click', onCanvasClick);
            
            // Control buttons
            document.getElementById('resetView').addEventListener('click', resetView);
            document.getElementById('topView').addEventListener('click', topView);
            document.getElementById('sideView').addEventListener('click', sideView);
            
            // Start animation loop
            animate();
        }
        
        // Create the 3D handpan model
        function createHandpan() {
            // Handpan body (main shell)
            const bodyGeometry = new THREE.CylinderGeometry(1.5, 1.3, 0.3, 32);
            const bodyMaterial = new THREE.MeshStandardMaterial({
                color: 0x9b870c,
                metalness: 0.8,
                roughness: 0.3
            });
            handpan = new THREE.Mesh(bodyGeometry, bodyMaterial);
            handpan.castShadow = true;
            handpan.receiveShadow = true;
            scene.add(handpan);
            
            // Top surface
            const topGeometry = new THREE.CylinderGeometry(1.4, 1.4, 0.05, 32);
            const topMaterial = new THREE.MeshStandardMaterial({
                color: 0xd4af37,
                metalness: 0.9,
                roughness: 0.2
            });
            const topSurface = new THREE.Mesh(topGeometry, topMaterial);
            topSurface.position.y = 0.175;
            topSurface.castShadow = true;
            topSurface.receiveShadow = true;
            handpan.add(topSurface);
            
            // Center hole (Gu)
            const holeGeometry = new THREE.CylinderGeometry(0.2, 0.2, 0.06, 16);
            const holeMaterial = new THREE.MeshStandardMaterial({
                color: 0x000000,
                metalness: 0.5,
                roughness: 0.5
            });
            const centerHole = new THREE.Mesh(holeGeometry, holeMaterial);
            centerHole.position.y = 0.2;
            handpan.add(centerHole);
            
            // Create notes
            createNotes();
        }
        
        // Create the note areas
        function createNotes() {
            // Note sizes
            const dingSize = 0.3;
            const outerNoteSize = 0.25;
            
            for (let i = 0; i < notePositions.length; i++) {
                const pos = notePositions[i];
                const size = i === 0 ? dingSize : outerNoteSize;
                
                // Create note geometry
                const noteGeometry = new THREE.CylinderGeometry(size, size, 0.02, 32);
                const noteMaterial = new THREE.MeshStandardMaterial({
                    color: i === 0 ? 0xd4af37 : 0x9b870c,
                    metalness: 0.95,
                    roughness: 0.1,
                    transparent: true,
                    opacity: 0.7
                });
                
                const note = new THREE.Mesh(noteGeometry, noteMaterial);
                note.position.set(pos.x, 0.2, pos.z);
                note.rotation.x = Math.PI / 2;
                note.userData.noteIndex = i;
                note.castShadow = true;
                note.receiveShadow = true;
                
                handpan.add(note);
                notes.push(note);
            }
        }
        
        // Play a note
        function playNote(noteIndex) {
            // Visual feedback - highlight
            const note = notes[noteIndex];
            note.material.color.set(0xff9900);
            note.material.emissive = new THREE.Color(0xff9900);
            note.material.emissiveIntensity = 0.5;
            
            // Reset after delay
            setTimeout(() => {
                note.material.color.set(noteIndex === 0 ? 0xd4af37 : 0x9b870c);
                note.material.emissive = new THREE.Color(0x000000);
                note.material.emissiveIntensity = 0;
            }, 300);
            
            // Show note name
            const noteNames = ["Ding (D)", "A3", "Bb3", "C4", "D4", "E4", "F4", "G4", "A4"];
            noteDisplay.textContent = noteNames[noteIndex];
            noteDisplay.style.opacity = 1;
            
            setTimeout(() => {
                noteDisplay.style.opacity = 0;
            }, 1000);
            
            // Play sound using Tone.js
            const synth = new Tone.Synth({
                oscillator: {
                    type: "sine"
                },
                envelope: {
                    attack: 0.01,
                    decay: 0.2,
                    sustain: 0.3,
                    release: 1.5
                }
            }).toDestination();
            
            synth.triggerAttackRelease(noteFrequencies[noteIndex], "8n");
        }
        
        // Event handlers
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function onMouseDown(event) {
            isDragging = true;
            previousMousePosition = {
                x: event.clientX,
                y: event.clientY
            };
        }
        
        function onMouseMove(event) {
            if (!isDragging) return;
            
            const deltaX = event.clientX - previousMousePosition.x;
            const deltaY = event.clientY - previousMousePosition.y;
            
            handpan.rotation.y += deltaX * 0.01;
            handpan.rotation.x += deltaY * 0.01;
            
            // Limit rotation
            handpan.rotation.x = Math.max(-Math.PI/4, Math.min(Math.PI/4, handpan.rotation.x));
            
            previousMousePosition = {
                x: event.clientX,
                y: event.clientY
            };
        }
        
        function onMouseUp() {
            isDragging = false;
        }
        
        function onMouseWheel(event) {
            event.preventDefault();
            camera.position.z += event.deltaY * 0.01;
            camera.position.z = Math.max(1.5, Math.min(8, camera.position.z));
        }
        
        function onCanvasClick(event) {
            // Calculate mouse position in normalized device coordinates
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
            
            // Update the picking ray with the camera and mouse position
            raycaster.setFromCamera(mouse, camera);
            
            // Calculate objects intersecting the picking ray
            const intersects = raycaster.intersectObjects(notes);
            
            if (intersects.length > 0) {
                // Play the note that was clicked
                const noteIndex = intersects[0].object.userData.noteIndex;
                playNote(noteIndex);
            }
        }
        
        // View controls
        function resetView() {
            camera.position.set(0, 1.5, 3);
            handpan.rotation.set(0, 0, 0);
        }
        
        function topView() {
            camera.position.set(0, 3, 0.1);
            handpan.rotation.set(0, 0, 0);
        }
        
        function sideView() {
            camera.position.set(2, 1, 0);
            handpan.rotation.set(0, Math.PI/2, 0);
        }
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            // Add subtle rotation for visual appeal
            if (!isDragging) {
                handpan.rotation.y += 0.001;
            }
            
            renderer.render(scene, camera);
        }
        
        // Initialize the application
        init();
    </script>
</body>
</html>
